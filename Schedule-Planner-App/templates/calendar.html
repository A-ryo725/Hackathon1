{% extends "base.html" %}
{% block content %}
<div class="max-w-6xl mx-auto">
    
    <div class="flex flex-col lg:flex-row gap-8 items-start">

        <div class="flex-1 bg-white p-8 rounded-3xl shadow-sm border border-gray-100 w-full">
            <div class="flex justify-between items-center mb-8">
                <div class="flex items-center gap-3">
                    <h3 class="text-xl font-bold text-gray-700">{{ year }}年 {{ month }}月</h3>
                    
                    <label class="relative cursor-pointer text-indigo-500 hover:text-indigo-700 p-2 rounded-full hover:bg-indigo-50 transition-colors">
                        <i class="fa-solid fa-calendar-check text-lg"></i>
                        <input type="month" 
                               class="absolute inset-0 opacity-0 cursor-pointer w-8 h-8" 
                               onchange="jumpToMonth(this.value)"
                               value="{{ year }}-{{ '%02d' % month }}">
                    </label>
                </div>

                <div class="flex gap-2">
                    <a href="/calendar?year={{ prev_year }}&month={{ prev_month }}" 
                       class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-full transition-all">
                        <i class="fa-solid fa-chevron-left"></i>
                    </a>
                    <a href="/calendar?year={{ next_year }}&month={{ next_month }}" 
                       class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-full transition-all">
                        <i class="fa-solid fa-chevron-right"></i>
                    </a>
                </div>
            </div>

            <div class="grid grid-cols-7 text-center mb-6 text-sm font-bold text-gray-400">
                <span class="text-red-400">日</span>
                <span>月</span><span>火</span><span>水</span><span>木</span><span>金</span>
                <span class="text-blue-400">土</span>
            </div>
            
            <div class="grid grid-cols-7 text-center gap-4">
                {% for day in cal_days %}
                <div class="aspect-square flex items-center justify-center">
                    {% if day != '' %}
                        {% set date_str = "%04d-%02d-%02d" % (year, month, day) %}
                        <button onclick="loadHistory('{{ date_str }}', this)" 
                                class="calendar-day-btn w-12 h-12 rounded-full transition-all flex flex-col items-center justify-center font-bold relative group
                                {% if day == today %} bg-indigo-600 text-white shadow-lg shadow-indigo-200
                                {% else %} hover:bg-indigo-50 text-gray-600 {% endif %}"
                                data-date="{{ date_str }}">
                            <span class="z-10">{{ day }}</span>
                            <div class="selection-marker absolute inset-0 border-2 border-indigo-500 rounded-full hidden"></div>
                        </button>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="w-full lg:w-96 bg-white p-6 rounded-3xl shadow-sm border border-gray-100 min-h-[500px]">
            <h3 id="historyTitle" class="text-lg font-bold mb-6 flex items-center gap-2 text-gray-700">
                <span id="displayDateString">{{ month }}月{{ today }}日</span>
            </h3>
            
            <div id="historyContainer" class="space-y-3 max-h-[600px] overflow-y-auto pr-1 custom-scrollbar">
                <p class="text-gray-400 text-sm">日付を選択してください</p>
            </div>
        </div>

    </div>
</div>

<script>
function jumpToMonth(val) {
    if(!val) return;
    const [y, m] = val.split('-');
    window.location.href = `/calendar?year=${y}&month=${parseInt(m)}`;
}

function updateSelectionStyle(btn) {
    document.querySelectorAll('.selection-marker').forEach(el => el.classList.add('hidden'));
    if(btn) {
        const marker = btn.querySelector('.selection-marker');
        if(marker) marker.classList.remove('hidden');
    }
}

async function loadHistory(date, btnElement) {
    if(btnElement) updateSelectionStyle(btnElement);

   
    const [y, m, d] = date.split('-');  //タイトルの日付更新
    document.getElementById('displayDateString').innerText = `${parseInt(m)}月${parseInt(d)}日 (${getDayName(date)})`;

    const container = document.getElementById('historyContainer');
    container.innerHTML = "<div class='text-center py-10'><i class='fa-solid fa-spinner fa-spin text-indigo-300 text-2xl'></i></div>";

    try {
        const res = await fetch(`/api/get_plan/${date}`);
        const data = await res.json();
        container.innerHTML = "";

        if (!data.schedule || data.schedule.length === 0) {
            container.innerHTML = `
                <div class="text-center py-10 bg-gray-50 rounded-xl border border-dashed border-gray-200">
                    <p class="text-gray-400 text-sm">予定はありません</p>
                </div>`;
            return;
        }

        data.schedule.forEach(item => {
            const div = document.createElement('div');
            let bgClass = "bg-indigo-50 border-indigo-100"; //タイプで色分け
            if (item.type === 'fixed') bgClass = "bg-orange-50 border-orange-100";
            if (item.task.includes("食事")) bgClass = "bg-yellow-50 border-yellow-100";

            div.className = `flex justify-between items-center p-4 rounded-xl border ${bgClass} transition-transform hover:scale-[1.02]`;
            div.innerHTML = `
                <div class="flex flex-col">
                    <span class="font-bold text-gray-700 text-sm">${item.task}</span>
                </div>
                <span class="text-xs font-mono text-gray-400">${item.time}</span>
            `;
            container.appendChild(div);
        });
    } catch (e) {
        container.innerHTML = "<p class='text-red-300 italic text-sm'>取得エラー</p>";
    }
}

function getDayName(dateStr) {
    const date = new Date(dateStr);
    const days = ['日', '月', '火', '水', '木', '金', '土'];
    return days[date.getDay()];
}

window.onload = () => {
    {% if today %}
    const todayStr = "{{ '%04d-%02d-%02d' % (year, month, today) }}";
    const btns = document.querySelectorAll('.calendar-day-btn');
    btns.forEach(btn => {
        if(btn.dataset.date === todayStr) {
            updateSelectionStyle(btn);
            loadHistory(todayStr, btn);
        }
    });
    {% endif %}
};
</script>

<style>
.custom-scrollbar::-webkit-scrollbar { width: 4px; }
.custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 4px; }
</style>
{% endblock %}